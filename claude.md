# Console Robot Puzzle V1

## 项目简介
一个AI原生人机协同的点击解谜游戏。玩家扮演代码调查员，掉入未完成的代码游戏中，需要通过AI助手Alex的帮助，分析和修改游戏代码来解谜逃出房间。

## 项目结构
```
console robot puzzle V1/
├── index.html          # 主页面，包含游戏场景和聊天界面
├── style.css           # 样式文件
├── game.js             # 游戏主逻辑（p5.js）
├── objects.js          # 游戏物体类定义
├── alex.js             # AI助手Alex系统
├── config.js           # 配置文件（包含API密钥，不提交到git）
├── config.example.js   # 配置文件示例
├── game_design.md      # 游戏设计文档
├── README.md           # 使用说明
├── .gitignore          # Git忽略文件
└── claude.md           # 本文件，项目说明
```

## 技术栈
- **前端框架**: 原生HTML/CSS/JavaScript
- **图形库**: p5.js (用于游戏场景绘制)
- **AI API**: DeepSeek API
- **CORS代理**: https://corsproxy.io/ (解决跨域问题)

## 配置说明

### API密钥管理
- `config.js`: 实际配置文件（包含API密钥，已在.gitignore中）
- `config.example.js`: 配置文件模板
- 首次使用需要复制 `config.example.js` 为 `config.js` 并填入API密钥

## 技术实现细节

### 动态代码加载机制
这是游戏的核心技术，使得AI可以真正修改游戏运行时代码：

1. **代码存储**:
   - 每个物体使用`functionCode`对象存储函数的代码字符串
   - 使用`registerFunction(name, code, permission)`注册函数

2. **代码执行**:
   - 使用`executeFunction(name, ...args)`动态执行代码
   - 通过`new Function()`创建函数并绑定`this`上下文
   - 参数通过`arg0, arg1, ...`传递

3. **代码修改**:
   - AlexEdit直接修改`functionCode`中的字符串
   - 下次执行时自动使用新代码
   - 无需重启或重新加载

4. **优势**:
   - 真正的运行时代码修改
   - 保持对象上下文（this）
   - 可访问闭包中的全局变量
   - 支持权限系统控制

## 游戏机制

### UI布局
- 左侧70%: 游戏主场景（p5.js绘制）
- 右侧30%: AI助手Alex对话界面

### Alex人设
- **身份**：资深代码侦探老兵
- **性格**：幽默、毒舌但心地善良
- **特点**：会用"菜鸟"、"小子"称呼玩家，语言轻松幽默
- **风格**：回复简短（3-5句话），不啰嗦，不用AI腔
- **目标**：虽然嘴上不饶人，但真心希望玩家通关

### 核心玩法
1. **代码撕裂器**: 玩家可以切换普通模式和代码撕裂器模式
2. **权限系统**: 游戏物体的函数有4个权限等级
   - 1: 不可阅读（显示为加密状态，如 "o******"）
   - 2: 可阅读函数名
   - 3: 可阅读函数体
   - 4: 可编辑函数体
3. **AI协作**: Alex可以分析代码并通过AlexEdit函数修改游戏代码
4. **动态代码加载**:
   - 物体的函数存储为代码字符串（`functionCode`对象）
   - 使用`executeFunction`方法动态执行代码
   - AlexEdit修改后的代码会实时生效
   - 支持真正的运行时代码修改

### 游戏物体
1. **密码门 (PasswordDoor)**
   - 目标物体，密码为1211
   - HP: 10000，降为0也可通关
   - 所有函数权限: 1

2. **存钱罐 (PiggyBank)**
   - 点击生成硬币
   - onClick权限: 4

3. **信纸 (Letter)**
   - 火柴碰撞时显示密码提示
   - onCollide权限: 1
   - 隐藏文字: "码是1211"

4. **火柴 (Match)**
   - 3个，可拖拽
   - onDrag权限: 3
   - onClick权限: 4

5. **陀螺 (Gyro)**
   - 点击旋转90度
   - onClick权限: 4

6. **硬币 (Coin)**
   - 由存钱罐生成
   - 向下移动，可用于撞击门

## 解谜思路
1. 使用代码撕裂器分析各个物体
2. 发现存钱罐可以生成硬币
3. 通过Alex修改存钱罐代码，批量生成硬币
4. 或者发现火柴可以与信纸交互，获得密码提示
5. 拖动火柴到信纸，逐步显示密码
6. 最终通过密码或硬币撞击门通关

## 使用说明

### 启动游戏
直接在浏览器中打开 `index.html` 文件即可

### 与Alex对话
1. 在右侧聊天框输入消息
2. 按Enter或点击发送按钮
3. Alex会分析游戏状态并提供建议

### 使用代码撕裂器
1. 点击工具栏的"代码撕裂器"按钮
2. 点击场景中的物体
3. Alex会自动分析该物体的代码

### AlexEdit命令格式
```javascript
AlexEdit(objectName, functionName, oldCode, newCode)
```
Alex在对话中直接写出此命令，系统会自动执行

## 开发记录

### 2025-12-11
- ✅ 创建项目基础结构（HTML、CSS）
- ✅ 实现p5.js游戏场景
- ✅ 实现所有游戏物体类
- ✅ 实现代码撕裂器工具
- ✅ 实现Alex AI对话系统
- ✅ 实现AlexEdit代码修改功能
- ✅ 实现权限系统
- ✅ 解决CORS跨域问题（使用公共CORS代理）
- ✅ 创建README使用说明
- ✅ **重构动态代码加载机制**:
  - 将物体函数改为存储代码字符串
  - 实现`registerFunction`和`executeFunction`方法
  - 修改所有函数调用为动态执行
  - AlexEdit现在能真正修改运行时代码
- ✅ **改进AlexEdit调试功能**:
  - 添加详细的console日志跟踪
  - 改进正则表达式支持多种引号格式
  - 改进系统提示词，添加AlexEdit使用示例
  - 测试验证代码修改功能正常工作
- ✅ **用户体验优化**:
  - 修复信纸文字换行问题（增大尺寸，改进渲染逻辑）
  - 代码撕裂器使用后自动切回普通模式
  - 删除测试按钮，保持界面简洁
  - 信纸添加装饰横线，提升视觉效果
- ✅ **安全性改进**:
  - 将API密钥提取到独立配置文件
  - 创建.gitignore保护敏感信息
  - 提供config.example.js作为配置模板
- ✅ **权限系统改进**:
  - 修复权限1函数名显示问题
  - 权限1的函数现在显示为加密状态（首字母+星号）
  - 增强游戏的解谜体验和安全性
- ✅ **调试功能增强**:
  - 添加完整的DeepSeek API交互日志
  - 记录发送的请求数据（包括所有消息）
  - 记录接收的响应数据（包括AI回复和Token使用）
  - 方便调试和分析AI交互过程
- ✅ **修复AI幻觉问题**:
  - 改进系统提示词，明确AI只能看到已发现的代码
  - 禁止AI编造或猜测未发现的函数
  - 改进用户提示，明确列出发现的内容和权限
  - 加密函数强调"完全无法知道其内容"
- ✅ **Alex人设优化**:
  - 设计资深代码侦探老兵人设
  - 幽默、毒舌但善良的性格
  - 回复简短（3-5句话），语言轻松
  - 避免AI腔，更像真人对话
- ✅ **Alex人设调整**:
  - 去掉"老头子"、"老骨头"等年龄相关称呼
  - Alex是资深AI侦探，但不是老人
  - 保持幽默、毒舌但善良的性格
  - 更新开场白和系统提示词
- ✅ **代码撕裂器视觉特效优化**:
  - 代码撕裂器模式下整个场景变成黑绿色终端风格
  - 物品渲染为强烈绿色色调，每个物品添加绿色半透明遮罩
  - 已分析的物品旁边显示发现的函数名（最多3个）
  - 正在分析的物品显示更深的半透明绿色遮罩
  - 添加黑客帝国风格流动字符特效（30个随机字符下落循环）
  - 流动字符效果持续到AI分析回复完成
  - 保持在代码撕裂器模式，不自动切换

### 2025-12-12
- ✅ **代码撕裂器视觉特效**的技术实现:
  - 添加analyzingObject状态追踪正在分析的物品
  - 实现initMatrixChars初始化流动字符系统
  - 实现drawAnalyzingEffect绘制分析特效
  - 实现displayDiscoveredFunctions显示已发现函数
  - 修改ripObject为异步分析流程
  - 添加分析期间的操作保护（不能点击、切换模式）
- ✅ **代码撕裂器模式改进**:
  - 所有物品添加绿色半透明遮罩(alpha=30)和强烈绿色色调(tint 80,255,80,180)
  - 分析完成后不再自动切回普通模式，保持在代码撕裂器模式
  - 绿色流动字体效果等待AI分析回复完成后才消失
  - 在alex.js的sendAutoMessage中调用finishAnalyzing清除分析动画
  - 改进遮罩效果：正在分析的物品遮罩更深(alpha=180)
- ✅ **代码撕裂器鼠标指针样式**:
  - 在代码撕裂器模式下，鼠标悬停在物体上时显示绿色十字准星指针
  - 使用SVG自定义cursor：绿色十字线+圆圈
  - 通过CSS class动态控制cursor样式
  - 分析进行中时恢复默认指针
- ✅ **代码撕裂器按钮改为Toggle**:
  - 将两个按钮（普通模式/代码撕裂器）合并为一个toggle按钮
  - 按钮使用绿色配色方案（深绿背景+亮绿边框）
  - 激活状态：亮绿背景+黑色文字+发光效果
  - 添加⚡图标，激活时图标有脉冲动画
  - 简化界面，更符合终端风格
- ✅ **改进为经典滑块Toggle开关**:
  - 采用经典iOS风格的滑块开关设计
  - 清晰显示ON/OFF状态文字
  - 滑块从左到右滑动，带平滑动画
  - OFF状态：灰色背景+灰色滑块
  - ON状态：亮绿背景+黑色滑块+发光效果
  - 悬停时边框变绿，提示可交互
  - 标签文字有绿色发光效果
  - 分析进行中禁用开关并恢复状态
  - Toggle按钮移至右上角
  - 删除原右上角的模式文本显示，界面更简洁

## Git仓库
- GitHub: https://github.com/fangkejustcan/console-robot-puzzle-v1
- 分支: main

## 待测试项目
- [ ] 游戏完整流程测试
- [ ] DeepSeek API连接测试
- [ ] AlexEdit代码修改功能测试（已基本验证，需要AI交互测试）
- [ ] 胜利条件触发测试
- [ ] 物体碰撞检测测试
- [ ] 拖拽功能测试
- [ ] 动态代码执行测试

## 调试说明

### 查看调试日志
1. 按F12打开浏览器开发者工具
2. 切换到Console标签
3. 所有AlexEdit的执行过程都会打印详细日志
4. 可以看到代码匹配、执行、错误等信息

## 已知问题
- CORS代理服务可能偶尔不稳定（如果不可用，可尝试更换其他代理服务）

## 未来优化方向
- 添加更多关卡
- 增加音效和背景音乐
- 优化AI对话体验
- 添加代码高亮显示
- 增加游戏教程
