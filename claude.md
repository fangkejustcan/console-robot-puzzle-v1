# Console Robot Puzzle V1

## 项目简介
一个AI原生人机协同的点击解谜游戏。玩家扮演代码调查员，掉入未完成的代码游戏中，需要通过AI助手Alex的帮助，分析和修改游戏代码来解谜逃出房间。

## 项目结构
```
console robot puzzle V1/
├── index.html          # 主页面，包含游戏场景和聊天界面
├── style.css           # 样式文件
├── game.js             # 游戏主逻辑（p5.js）
├── objects.js          # 游戏物体类定义
├── alex.js             # AI助手Alex系统
├── game_design.md      # 游戏设计文档
├── README.md           # 使用说明
└── claude.md           # 本文件，项目说明
```

## 技术栈
- **前端框架**: 原生HTML/CSS/JavaScript
- **图形库**: p5.js (用于游戏场景绘制)
- **AI API**: DeepSeek API
- **API Key**: sk-e34c5479a3754a6495e4d607232d7e49
- **CORS代理**: https://corsproxy.io/ (解决跨域问题)

## 技术实现细节

### 动态代码加载机制
这是游戏的核心技术，使得AI可以真正修改游戏运行时代码：

1. **代码存储**:
   - 每个物体使用`functionCode`对象存储函数的代码字符串
   - 使用`registerFunction(name, code, permission)`注册函数

2. **代码执行**:
   - 使用`executeFunction(name, ...args)`动态执行代码
   - 通过`new Function()`创建函数并绑定`this`上下文
   - 参数通过`arg0, arg1, ...`传递

3. **代码修改**:
   - AlexEdit直接修改`functionCode`中的字符串
   - 下次执行时自动使用新代码
   - 无需重启或重新加载

4. **优势**:
   - 真正的运行时代码修改
   - 保持对象上下文（this）
   - 可访问闭包中的全局变量
   - 支持权限系统控制

## 游戏机制

### UI布局
- 左侧70%: 游戏主场景（p5.js绘制）
- 右侧30%: AI助手Alex对话界面

### 核心玩法
1. **代码撕裂器**: 玩家可以切换普通模式和代码撕裂器模式
2. **权限系统**: 游戏物体的函数有4个权限等级
   - 1: 不可阅读
   - 2: 可阅读函数名
   - 3: 可阅读函数体
   - 4: 可编辑函数体
3. **AI协作**: Alex可以分析代码并通过AlexEdit函数修改游戏代码
4. **动态代码加载**:
   - 物体的函数存储为代码字符串（`functionCode`对象）
   - 使用`executeFunction`方法动态执行代码
   - AlexEdit修改后的代码会实时生效
   - 支持真正的运行时代码修改

### 游戏物体
1. **密码门 (PasswordDoor)**
   - 目标物体，密码为1211
   - HP: 10000，降为0也可通关
   - 所有函数权限: 1

2. **存钱罐 (PiggyBank)**
   - 点击生成硬币
   - onClick权限: 4

3. **信纸 (Letter)**
   - 火柴碰撞时显示密码提示
   - onCollide权限: 1
   - 隐藏文字: "码是1211"

4. **火柴 (Match)**
   - 3个，可拖拽
   - onDrag权限: 3
   - onClick权限: 4

5. **陀螺 (Gyro)**
   - 点击旋转90度
   - onClick权限: 4

6. **硬币 (Coin)**
   - 由存钱罐生成
   - 向下移动，可用于撞击门

## 解谜思路
1. 使用代码撕裂器分析各个物体
2. 发现存钱罐可以生成硬币
3. 通过Alex修改存钱罐代码，批量生成硬币
4. 或者发现火柴可以与信纸交互，获得密码提示
5. 拖动火柴到信纸，逐步显示密码
6. 最终通过密码或硬币撞击门通关

## 使用说明

### 启动游戏
直接在浏览器中打开 `index.html` 文件即可

### 与Alex对话
1. 在右侧聊天框输入消息
2. 按Enter或点击发送按钮
3. Alex会分析游戏状态并提供建议

### 使用代码撕裂器
1. 点击工具栏的"代码撕裂器"按钮
2. 点击场景中的物体
3. Alex会自动分析该物体的代码

### AlexEdit命令格式
```javascript
AlexEdit(objectName, functionName, oldCode, newCode)
```
Alex在对话中直接写出此命令，系统会自动执行

## 开发记录

### 2025-12-11
- ✅ 创建项目基础结构（HTML、CSS）
- ✅ 实现p5.js游戏场景
- ✅ 实现所有游戏物体类
- ✅ 实现代码撕裂器工具
- ✅ 实现Alex AI对话系统
- ✅ 实现AlexEdit代码修改功能
- ✅ 实现权限系统
- ✅ 解决CORS跨域问题（使用公共CORS代理）
- ✅ 创建README使用说明
- ✅ **重构动态代码加载机制**:
  - 将物体函数改为存储代码字符串
  - 实现`registerFunction`和`executeFunction`方法
  - 修改所有函数调用为动态执行
  - AlexEdit现在能真正修改运行时代码
- ✅ **改进AlexEdit调试功能**:
  - 添加详细的console日志跟踪
  - 改进正则表达式支持多种引号格式
  - 改进系统提示词，添加AlexEdit使用示例
  - 测试验证代码修改功能正常工作
- ✅ **用户体验优化**:
  - 修复信纸文字换行问题（增大尺寸，改进渲染逻辑）
  - 代码撕裂器使用后自动切回普通模式
  - 删除测试按钮，保持界面简洁
  - 信纸添加装饰横线，提升视觉效果

## 待测试项目
- [ ] 游戏完整流程测试
- [ ] DeepSeek API连接测试
- [ ] AlexEdit代码修改功能测试（已基本验证，需要AI交互测试）
- [ ] 胜利条件触发测试
- [ ] 物体碰撞检测测试
- [ ] 拖拽功能测试
- [ ] 动态代码执行测试

## 调试说明

### 查看调试日志
1. 按F12打开浏览器开发者工具
2. 切换到Console标签
3. 所有AlexEdit的执行过程都会打印详细日志
4. 可以看到代码匹配、执行、错误等信息

## 已知问题
- CORS代理服务可能偶尔不稳定（如果不可用，可尝试更换其他代理服务）

## 未来优化方向
- 添加更多关卡
- 增加音效和背景音乐
- 优化AI对话体验
- 添加代码高亮显示
- 增加游戏教程
