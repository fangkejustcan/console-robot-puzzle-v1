# Console Robot Puzzle V1

## 项目简介
一个AI原生人机协同的点击解谜游戏。玩家扮演代码调查员，掉入未完成的代码游戏中，需要通过AI助手Alex的帮助，分析和修改游戏代码来解谜逃出房间。

## 项目结构
```
console robot puzzle V1/
├── index.html          # 主页面，包含游戏场景和聊天界面
├── style.css           # 样式文件
├── game.js             # 游戏主逻辑（p5.js）
├── objects.js          # 游戏物体类定义
├── alex.js             # AI助手Alex系统
├── config.js           # 配置文件（包含API密钥，不提交到git）
├── config.example.js   # 配置文件示例
├── game_design.md      # 游戏设计文档
├── README.md           # 使用说明
├── .gitignore          # Git忽略文件
└── claude.md           # 本文件，项目说明
```

## 技术栈
- **前端框架**: 原生HTML/CSS/JavaScript
- **图形库**: p5.js (用于游戏场景绘制)
- **AI API**: DeepSeek API
- **CORS代理**: https://corsproxy.io/ (解决跨域问题)

## 配置说明

### API密钥管理
- `config.js`: 实际配置文件（包含API密钥，已在.gitignore中）
- `config.example.js`: 配置文件模板
- 首次使用需要复制 `config.example.js` 为 `config.js` 并填入API密钥

## 技术实现细节

### 动态代码加载机制
这是游戏的核心技术，使得AI可以真正修改游戏运行时代码：

1. **代码存储**:
   - 每个物体使用`functionCode`对象存储函数的代码字符串
   - 使用`registerFunction(name, code, permission)`注册函数

2. **代码执行**:
   - 使用`executeFunction(name, ...args)`动态执行代码
   - 通过`new Function()`创建函数并绑定`this`上下文
   - 参数通过`arg0, arg1, ...`传递

3. **代码修改**:
   - AlexEdit直接修改`functionCode`中的字符串
   - 下次执行时自动使用新代码
   - 无需重启或重新加载

4. **优势**:
   - 真正的运行时代码修改
   - 保持对象上下文（this）
   - 可访问闭包中的全局变量
   - 支持权限系统控制

## 游戏机制

### UI布局
- 左侧70%: 游戏主场景（p5.js绘制）
- 右侧30%: AI助手Alex对话界面

### Alex人设
- **身份**：资深代码侦探老兵
- **性格**：幽默、毒舌但心地善良
- **特点**：会用"菜鸟"、"小子"称呼玩家，语言轻松幽默
- **风格**：回复简短（3-5句话），不啰嗦，不用AI腔
- **目标**：虽然嘴上不饶人，但真心希望玩家通关

### 核心玩法
1. **代码撕裂器**: 玩家可以切换普通模式和代码撕裂器模式
2. **权限系统**: 游戏物体的函数有4个权限等级
   - 1: 不可阅读（显示为加密状态，如 "o******"）
   - 2: 可阅读函数名
   - 3: 可阅读函数体
   - 4: 可编辑函数体
3. **AI协作**: Alex可以分析代码并通过AlexEdit函数修改游戏代码
4. **动态代码加载**:
   - 物体的函数存储为代码字符串（`functionCode`对象）
   - 使用`executeFunction`方法动态执行代码
   - AlexEdit修改后的代码会实时生效
   - 支持真正的运行时代码修改

### 游戏物体
1. **密码门 (PasswordDoor)**
   - 目标物体，密码为1211
   - HP: 10000，降为0也可通关
   - 所有函数权限: 1

2. **存钱罐 (PiggyBank)**
   - 点击生成硬币
   - onClick权限: 4

3. **信纸 (Letter)**
   - 火柴碰撞时显示密码提示
   - onCollide权限: 1
   - 隐藏文字: "码是1211"

4. **火柴 (Match)**
   - 3个，可拖拽
   - onDrag权限: 3
   - onClick权限: 4

5. **陀螺 (Gyro)**
   - 点击旋转90度
   - onClick权限: 4

6. **硬币 (Coin)**
   - 由存钱罐生成
   - 向下移动，可用于撞击门

## 解谜思路
1. 使用代码撕裂器分析各个物体
2. 发现存钱罐可以生成硬币
3. 通过Alex修改存钱罐代码，批量生成硬币
4. 或者发现火柴可以与信纸交互，获得密码提示
5. 拖动火柴到信纸，逐步显示密码
6. 最终通过密码或硬币撞击门通关

## 使用说明

### 启动游戏
直接在浏览器中打开 `index.html` 文件即可

### 与Alex对话
1. 在右侧聊天框输入消息
2. 按Enter或点击发送按钮
3. Alex会分析游戏状态并提供建议

### 使用代码撕裂器
1. 点击工具栏的"代码撕裂器"按钮
2. 点击场景中的物体
3. Alex会自动分析该物体的代码

### AlexEdit命令格式
```javascript
AlexEdit(objectName, functionName, oldCode, newCode)
```
Alex在对话中直接写出此命令，系统会自动执行

## 开发记录

### 2025-12-11
- ✅ 创建项目基础结构（HTML、CSS）
- ✅ 实现p5.js游戏场景
- ✅ 实现所有游戏物体类
- ✅ 实现代码撕裂器工具
- ✅ 实现Alex AI对话系统
- ✅ 实现AlexEdit代码修改功能
- ✅ 实现权限系统
- ✅ 解决CORS跨域问题（使用公共CORS代理）
- ✅ 创建README使用说明
- ✅ **重构动态代码加载机制**:
  - 将物体函数改为存储代码字符串
  - 实现`registerFunction`和`executeFunction`方法
  - 修改所有函数调用为动态执行
  - AlexEdit现在能真正修改运行时代码
- ✅ **改进AlexEdit调试功能**:
  - 添加详细的console日志跟踪
  - 改进正则表达式支持多种引号格式
  - 改进系统提示词，添加AlexEdit使用示例
  - 测试验证代码修改功能正常工作
- ✅ **用户体验优化**:
  - 修复信纸文字换行问题（增大尺寸，改进渲染逻辑）
  - 代码撕裂器使用后自动切回普通模式
  - 删除测试按钮，保持界面简洁
  - 信纸添加装饰横线，提升视觉效果
- ✅ **安全性改进**:
  - 将API密钥提取到独立配置文件
  - 创建.gitignore保护敏感信息
  - 提供config.example.js作为配置模板
- ✅ **权限系统改进**:
  - 修复权限1函数名显示问题
  - 权限1的函数现在显示为加密状态（首字母+星号）
  - 增强游戏的解谜体验和安全性
- ✅ **调试功能增强**:
  - 添加完整的DeepSeek API交互日志
  - 记录发送的请求数据（包括所有消息）
  - 记录接收的响应数据（包括AI回复和Token使用）
  - 方便调试和分析AI交互过程
- ✅ **修复AI幻觉问题**:
  - 改进系统提示词，明确AI只能看到已发现的代码
  - 禁止AI编造或猜测未发现的函数
  - 改进用户提示，明确列出发现的内容和权限
  - 加密函数强调"完全无法知道其内容"
- ✅ **Alex人设优化**:
  - 设计资深代码侦探老兵人设
  - 幽默、毒舌但善良的性格
  - 回复简短（3-5句话），语言轻松
  - 避免AI腔，更像真人对话
- ✅ **Alex人设调整**:
  - 去掉"老头子"、"老骨头"等年龄相关称呼
  - Alex是资深AI侦探，但不是老人
  - 保持幽默、毒舌但善良的性格
  - 更新开场白和系统提示词
- ✅ **代码撕裂器视觉特效优化**:
  - 代码撕裂器模式下整个场景变成黑绿色终端风格
  - 物品渲染为强烈绿色色调，每个物品添加绿色半透明遮罩
  - 已分析的物品旁边显示发现的函数名（最多3个）
  - 正在分析的物品显示更深的半透明绿色遮罩
  - 添加黑客帝国风格流动字符特效（30个随机字符下落循环）
  - 流动字符效果持续到AI分析回复完成
  - 保持在代码撕裂器模式，不自动切换

### 2025-12-12
- ✅ **代码撕裂器视觉特效**的技术实现:
  - 添加analyzingObject状态追踪正在分析的物品
  - 实现initMatrixChars初始化流动字符系统
  - 实现drawAnalyzingEffect绘制分析特效
  - 实现displayDiscoveredFunctions显示已发现函数
  - 修改ripObject为异步分析流程
  - 添加分析期间的操作保护（不能点击、切换模式）
- ✅ **代码撕裂器模式改进**:
  - 所有物品添加绿色半透明遮罩(alpha=30)和强烈绿色色调(tint 80,255,80,180)
  - 分析完成后不再自动切回普通模式，保持在代码撕裂器模式
  - 绿色流动字体效果等待AI分析回复完成后才消失
  - 在alex.js的sendAutoMessage中调用finishAnalyzing清除分析动画
  - 改进遮罩效果：正在分析的物品遮罩更深(alpha=180)
- ✅ **代码撕裂器鼠标指针样式**:
  - 在代码撕裂器模式下，鼠标悬停在物体上时显示绿色十字准星指针
  - 使用SVG自定义cursor：绿色十字线+圆圈
  - 通过CSS class动态控制cursor样式
  - 分析进行中时恢复默认指针
- ✅ **代码撕裂器按钮改为Toggle**:
  - 将两个按钮（普通模式/代码撕裂器）合并为一个toggle按钮
  - 按钮使用绿色配色方案（深绿背景+亮绿边框）
  - 激活状态：亮绿背景+黑色文字+发光效果
  - 添加⚡图标，激活时图标有脉冲动画
  - 简化界面，更符合终端风格
- ✅ **改进为经典滑块Toggle开关**:
  - 采用经典iOS风格的滑块开关设计
  - 清晰显示ON/OFF状态文字
  - 滑块从左到右滑动，带平滑动画
  - OFF状态：灰色背景+灰色滑块
  - ON状态：亮绿背景+黑色滑块+发光效果
  - 悬停时边框变绿，提示可交互
  - 标签文字有绿色发光效果
  - 分析进行中禁用开关并恢复状态
  - Toggle按钮移至右上角
  - 删除原右上角的模式文本显示，界面更简洁
- ✅ **简化AlexEdit逻辑**:
  - 改为直接覆盖整个函数代码，不再使用oldCode查找替换
  - 新的签名：AlexEdit(objectName, functionName, newCode)
  - AI直接提供完整的新函数体，简化使用
  - 更新系统提示词和示例
  - 修改processAlexEditCommands正则表达式匹配3个参数
  - 修改executeAlexEdit直接覆盖functionCode
- ✅ **代码撕裂器显示类名**:
  - GameObject自动获取类名（this.constructor.name）
  - getFunctionInfo返回className信息
  - buildSystemPrompt显示类名（如"Match_1 (类型: Match)"）
  - 帮助玩家识别物体类型
- ✅ **修复AI代码生成字符串引号问题**:
  - 在系统提示词中明确要求避免使用字符串字面量
  - 建议AI省略addSystemMessage调用
  - 专注于核心逻辑，避免引号解析错误
  - 更新示例代码去掉字符串使用

### 2025-12-17 (Session 1)
- ✅ **自然语言代码可视化系统**:
  - 为所有GameObject的函数添加自然语言描述（naturalDescription字段）
  - 描述格式：`<func>函数名</func>：<func>动作</func>一个<class>类名</class>`
  - 例如：`<func>点击时</func>：<func>生成</func>一个<class>金币</class>`
  - 便于玩家理解代码功能，无需阅读复杂的JavaScript代码
- ✅ **场景内词条渲染系统**:
  - 在代码撕裂器模式下，物体旁边显示代码信息卡片
  - 卡片使用DOM元素覆盖在canvas上，跟随物体位置更新
  - 自然语言描述中的词条渲染为带包围盒的可点击标签
  - **func词条**：绿色包围盒+绿色文字+发光效果
  - **class词条**：青色包围盒+青色文字+发光效果
  - 普通文本以灰白色显示，无包围盒
  - 只显示权限≥3的函数（最多3个）
- ✅ **词条收集机制**:
  - **手动点击收集**：必须点击场景中的词条才能收集
  - 收集时播放缩放动画和系统消息提示
  - **权限控制**：只有权限≥3的函数才显示描述和词条
  - **可重复收集**：词条收集后不会变灰，保持可点击状态
- ✅ **词条库系统**:
  - 词条库位于屏幕底部，横向滚动显示
  - 词条自动去重，按类型分类显示（func绿色，class青色）
  - 词条支持拖拽，可用于代码编辑
- ✅ **代码查看窗口**:
  - 双击已分析的物体打开代码查看窗口
  - 显示所有函数的信息（函数名、权限、自然语言描述）
  - 与场景内渲染类似，词条可点击收集
  - 权限1：显示"完全加密，无法读取"
  - 权限2：显示"只能看到函数名，内容加密"
  - 权限3：可查看描述和收集词条
  - 权限4：可查看、收集词条，并可点击"编辑函数"按钮
- ✅ **函数编辑器系统**:
  - 从代码查看窗口点击"编辑函数"按钮打开（仅权限4）
  - 编辑器将自然语言描述分解为可编辑的词条和文本
  - 支持从词条库拖拽词条到编辑器
  - 支持删除词条（悬停显示×按钮）
  - 支持直接编辑连接文字
  - 点击"生成并发送给Alex"按钮，将编辑好的自然语言描述发送给AI助手
  - AI助手根据自然语言描述生成实际的JavaScript代码
- ✅ **编辑器高级功能**:
  - **富文本编辑体验**：编辑器采用统一的contentEditable区域
    - 工作区整体可编辑，使用光标自由输入文本
    - 词条作为contentEditable=false的内联元素插入
    - 可以在词条前后任意位置打字，像使用普通文本编辑器一样
    - 空编辑器显示占位提示文字
  - **词条拖拽和编辑**：
    - 词条可以拖拽到光标位置，支持精确插入
    - 编辑器内词条可以拖拽移动到任意位置
    - 从词条库拖拽或点击添加词条
    - 词条悬停显示删除按钮，点击直接删除
  - **视觉反馈**：
    - 聚焦时编辑器边框高亮为青色
    - 拖拽时词条半透明显示
    - 拖入时编辑器背景微亮提示可放置
    - 删除按钮只在悬停时显示，不干扰正常编辑
- ✅ **交互流程优化**:
  - 简化玩家操作：不需要手动编写代码，只需拼接词条
  - 降低门槛：将编程转化为可视化的词条拼接游戏
  - 保留解谜性：玩家需要探索物体、理解权限、收集词条、组合逻辑
  - 增强反馈：收集词条时有动画和系统消息提示
  - 直观展示：词条直接显示在游戏场景中，所见即所得
- ✅ **用户体验改进**:
  - **代码卡片持久化**：切换代码撕裂器模式时，卡片不会消失，只是隐藏/显示
  - **内联编辑按钮**：权限4的函数在场景卡片中直接显示"编辑"按钮
  - **优化编辑器触发**：点击内联按钮即可打开函数编辑器，无需双击物体
  - **词条状态优化**：收集后的词条保持活跃状态，可重复点击收集
  - **词条库点击添加**：编辑器打开时，点击词条库中的词条可直接添加到编辑器末尾
  - **视觉反馈增强**：词条库词条点击时有缩放动画效果，系统消息实时反馈
  - **编辑器与词条库交互**：编辑器打开时词条库保持可用，通过z-index层级管理实现
    - 编辑器打开时词条库自动提升到z-index: 1001
    - 编辑器overlay底部留出120px空间避免遮挡词条库
    - 关闭编辑器时词条库恢复默认z-index: 100
  - **编辑器交互增强**：
    - 统一的contentEditable编辑区域，支持光标自由移动
    - 词条和文本无缝混合编辑，体验类似Word等文字处理软件
    - 词条可拖拽到光标位置，支持精确插入
    - 智能占位提示，空编辑器显示操作指引
- ✅ **编辑器技术实现**:
  - 采用contentEditable富文本编辑方案
  - 词条使用contentEditable="false"内联span元素
  - 文本作为普通文本节点，可自由编辑
  - 使用Selection API实现光标位置插入
  - 使用Range API实现拖拽位置精确控制
  - DOM直接操作避免频繁重新渲染，保持光标位置
- ✅ **编辑器与AI交互**:
  - 修改sendMessage函数支持参数传递
  - 编辑器点击"生成并发送给Alex"后自动触发AI思考
  - 修复了编辑器发送消息不触发AI回复的问题
- ✅ **AlexEdit增强功能**:
  - **同时更新代码和描述**：AlexEdit现在支持第4个可选参数newDescription
  - **签名**：`AlexEdit(objectName, functionName, newCode, newDescription)`
  - **自动刷新显示**：修改函数后自动更新场景中的代码卡片显示
  - **技术实现**：
    - 更新obj.naturalDescription[functionName]
    - 更新gameState.discoveredCode中的naturalDescription
    - 调用refreshCodeCard重新创建代码卡片
    - 删除旧卡片，创建新卡片以反映最新的自然语言描述
  - **AI提示词更新**：
    - 要求Alex在使用AlexEdit时提供新的自然语言描述
    - 描述必须使用<func>和<class>标签标记词条
    - 示例：`<func>点击时</func>：<func>生成</func>10个<class>金币</class>`

### 2025-12-17 (Session 2)
- ✅ **游戏场景布局调整**:
  - **问题**：底部词条库（高度120px）会遮挡游戏场景中的物体，特别是底部的火柴
  - **解决方案**：调整p5.js画布高度，为词条库预留空间
  - **技术实现**：
    - 修改setup()函数：createCanvas(windowWidth * 0.7, windowHeight - 120)
    - 修改windowResized()函数：resizeCanvas(windowWidth * 0.7, windowHeight - 120)
    - 画布高度减去词条库高度（120px），确保词条库不会覆盖游戏内容
  - **效果**：游戏物体完全可见，布局更加合理
- ✅ **碰撞检测逻辑**:
  - **设计**：保持简单的碰撞检测逻辑，每帧检测物体之间的碰撞
  - **实现**：只要两个物体发生碰撞（重叠），就触发onCollide函数
  - **效果**：物体在门内持续碰撞会持续触发碰撞事件
- ✅ **超出屏幕物体自动清理**:
  - **问题**：动态生成的物体（如硬币）超出屏幕后仍在内存中，导致游戏卡顿
  - **解决方案**：实现自动清理机制，删除超出屏幕的物体
  - **技术实现**：
    - 添加cleanupOffscreenObjects()函数
    - 每帧检测所有物体位置
    - 物体超出屏幕边界100px以上时删除
    - 同时清理相关的代码卡片和discoveredCode记录
    - 从后往前删除避免数组索引错乱
  - **效果**：游戏性能优化，不会因为大量超出屏幕的物体而卡顿
- ✅ **权限差异化渲染系统**:
  - **功能**：不同权限的函数在代码撕裂器中显示不同的内容
  - **权限1**：显示`<func>???</func>`（完全加密，不可读）
  - **权限2**：显示`<func>函数名</func>:<func>???</func>`（可读函数名，内容加密）
  - **权限3**：显示完整的自然语言描述（可读函数体）
  - **权限4**：显示完整的自然语言描述+编辑按钮（可编辑）
  - **技术实现**：
    - 修改createFunctionElement()函数，根据权限渲染不同内容
    - 权限1和2的函数使用红色加密样式（encrypted-func类）
    - 权限3和4解析并渲染完整的自然语言描述
    - 显示所有权限的函数（不再只显示权限>=3）
  - **效果**：玩家可以清楚看到哪些函数被加密，增强解谜体验
- ✅ **密钥破解系统**:
  - **功能**：玩家可以使用密钥破解权限1、2、3的函数，升级为权限4
  - **密钥设定**：所有加密函数统一使用"黄色密钥"破解
  - **UI实现**：
    - 权限<4的函数显示"🔓破解"按钮
    - 点击后弹出密钥破解窗口（金色主题）
    - 窗口提示需要"黄色密钥"，引导玩家从物品栏选择
    - 物品栏在破解窗口打开时提升到窗口上层（z-index: 1001）
    - 点击物品栏中的黄色密钥即可破解
    - 破解成功后函数权限升级为4，消耗一个黄色密钥
  - **技术实现**：
    - 添加openUnlockDialog()函数打开破解窗口
    - 添加attemptUnlockWithKey()函数处理密钥破解逻辑
    - 物品栏密钥点击事件：检查currentUnlockingFunction状态
    - 破解窗口打开时给物品栏添加unlock-active类
    - 检查是否为"黄色密钥"，验证通过后升级权限
    - 破解成功后从inventory中移除一个黄色密钥
    - 调用refreshCodeCard()刷新代码卡片显示
  - **交互流程**：
    1. 点击加密函数的"🔓破解"按钮
    2. 弹出破解窗口，提示需要黄色密钥
    3. 从下方物品栏中点击黄色密钥
    4. 破解成功，消耗密钥，函数升级为权限4
  - **效果**：直观的密钥使用体验，密钥作为消耗品增加策略性
- ✅ **物品栏系统**:
  - **功能**：将原来的"词条库"升级为"物品栏"，支持两种物品类型
  - **物品类型**：
    - **词条（token）**：{type: 'token', category: 'func'/'class', value: '词条内容'}
    - **密钥（key）**：{type: 'key', value: '密钥名称'}
  - **UI更新**：
    - 词条库改名为"物品栏"
    - 词条显示为绿色（func）或青色（class）
    - 密钥显示为金色，带🔑图标
    - 密钥不可拖拽，点击显示密钥信息
  - **技术实现**：
    - gameState.tokenLibrary改为gameState.inventory
    - 添加addItemToInventory()统一物品管理
    - 添加updateInventoryUI()支持渲染不同类型物品
    - 保留addTokenToLibrary()兼容旧代码
  - **效果**：统一的物品管理系统，支持未来扩展更多物品类型
- ✅ **胜利条件修改**:
  - **原设计**：输入正确密码1211后直接胜利
  - **新设计**：输入正确密码后获得5个黄色密钥
  - **技术实现**：
    - 修改PasswordDoor的onClick函数
    - 密码正确后循环添加5个"黄色密钥"到物品栏
    - 不再设置gameState.won = true
  - **游戏逻辑**：
    - 黄色密钥作为核心资源，可用于破解加密函数
    - 玩家需要策略性分配密钥使用
    - 5个密钥恰好可以破解5个加密函数
    - 鼓励玩家探索和使用密钥系统
    - 为后续关卡设计留下扩展空间
- ✅ **代码卡片智能位置调整**:
  - **功能**：根据物体位置智能显示代码卡片位置
  - **逻辑**：
    - 物体在画布60%以右：卡片显示在物体左侧
    - 物体在画布60%以左：卡片显示在物体右侧
  - **技术实现**：
    - 修改updateCodeCardPosition()函数
    - 根据obj.x与width * 0.6的比较决定位置
    - 使用card.offsetWidth计算左侧偏移量
  - **效果**：代码卡片不会超出屏幕边界，提升可读性

### 2025-12-18
- ✅ **权限系统重大重构 - 支持权限动态变化**:
  - **问题**：原设计使用discoveredCode缓存函数信息，当权限改变后，所有UI组件仍读取旧缓存，导致破解后无法看到更新
  - **根本原因**：系统设计时未充分考虑权限可变的情况，采用"问题出现再修补"的方式
  - **重构方案**：所有UI组件改为实时获取权限信息，不依赖可能过期的缓存
  - **技术实现**：
    - 修改createCodeCardForObject()：改为调用obj.getFunctionInfo()实时获取
    - 修改openCodeViewer()：先找到obj，再实时获取最新权限信息
    - 修改openFunctionEditor()：先找到obj，再实时获取最新权限信息
    - 修改openUnlockDialog()：先找到obj，再实时获取最新权限信息
    - 添加refreshCodeCard()函数：删除旧卡片，重新创建以反映最新权限
    - 修改attemptUnlockWithKey()：只更新obj.permissions，不更新discoveredCode缓存
    - discoveredCode保留用于标记"已分析"状态，但不再用于提供函数信息
  - **设计原则**：
    - 权限是可变的，所有读取权限的地方都应该实时查询最新状态
    - 避免维护可能过期的缓存数据
    - 权限改变后，通过refreshCodeCard()刷新所有依赖的UI组件
  - **效果**：
    - 破解后立即看到函数详情和编辑按钮
    - 所有UI组件（代码卡片、查看窗口、编辑器）都显示最新权限
    - 不会出现权限不一致或重复函数的问题
    - 代码更简单，不需要手动维护缓存一致性
- ✅ **修复API调用bug - 事件对象误传入**:
  - **问题**：编辑代码发送给Alex后，再直接对话时，对话内容变成`[object PointerEvent]`，导致API请求失败
  - **错误信息**：`messages[10]: content should be a string or a list`
  - **根本原因**：
    - 按钮点击事件监听器：`sendBtn.addEventListener('click', sendMessage)`
    - 当点击按钮时，浏览器传入PointerEvent对象作为第一个参数
    - sendMessage函数：`async function sendMessage(messageText = null, showInUI = true)`
    - 原逻辑：`if (messageText)` 会判断PointerEvent为true（因为是对象）
    - 结果：PointerEvent被当作消息内容添加到conversationHistory
  - **技术实现**：
    - 修改sendMessage函数的判断逻辑
    - 使用`typeof messageText === 'string' && messageText`严格检查参数类型
    - 确保只有字符串类型的messageText才被当作消息内容
    - 其他情况（包括事件对象）都从输入框读取内容
  - **效果**：
    - 修复了从编辑器发送消息后无法继续对话的问题
    - API请求正常，不再出现400错误
    - 代码更健壮，防止类型错误
- ✅ **API调用稳定性改进 - 超时和重试机制**:
  - **问题**：经常出现`ERR_CONNECTION_RESET`错误，导致对话中断
  - **根本原因**：
    - CORS代理服务(corsproxy.io)不够稳定
    - 没有请求超时设置，长时间无响应
    - 没有自动重试机制，网络波动时直接失败
    - 对话历史无限增长，请求体越来越大
  - **技术实现**：
    - 添加30秒超时：使用AbortController和setTimeout实现
    - 自动重试机制：网络错误时最多重试3次，每次间隔2秒
    - 限制对话历史：保留系统提示+最近20条消息，防止请求体过大
    - 错误类型识别：区分超时、连接重置、普通错误
    - 友好的错误提示：告知用户已尝试重连次数
  - **重试逻辑**：
    - 检测错误类型：AbortError（超时）、ERR_CONNECTION_RESET、Failed to fetch
    - 如果是网络错误且未达最大重试次数，等待2秒后自动重试
    - 达到最大重试次数后显示友好错误消息
    - 控制台记录每次重试
  - **效果**：
    - 大幅减少连接失败的情况
    - 临时网络波动不会导致对话中断
    - 请求体大小可控，不会因对话过长而失败
    - 用户体验更好，知道系统在尝试重连
- ✅ **AlexEdit引号解析bug修复**:
  - **问题**：Alex修改代码时，如果代码中包含引号（如`startsWith('Match')`），会导致正则表达式解析错误
  - **错误示例**：`AlexEdit("Letter", "onCollide", "if (arg0.name.startsWith('Match')) {...}", "...")`
  - **根本原因**：
    - 原正则表达式：`["'`]([\s\S]*?)["'`]` 匹配任意引号包裹的参数
    - 当代码内部有引号时，非贪婪匹配会提前结束
    - 例如：遇到`'Match'`中的单引号，错误地认为参数已结束
    - 导致提取的代码不完整，执行时出现语法错误
  - **技术实现**：
    - 修改正则表达式：第3个参数（代码）必须用反引号包裹
    - 新正则：`\`([\s\S]*?)\`` 只匹配反引号包裹的内容
    - JS代码中几乎不会出现反引号，可以安全使用
    - 第1、2、4个参数仍可使用任意引号
  - **优化系统提示词**：
    - 明确要求：newCode参数**必须用反引号包裹**
    - 添加正确示例：AlexEdit("Letter", "onCollide", \`code here\`, "desc")
    - 添加具体案例：展示包含引号的代码如何正确写
    - 强调关键点：反引号可以避免代码中的引号冲突
  - **效果**：
    - 完全解决代码中引号导致的解析错误
    - AI生成的AlexEdit命令格式正确
    - 支持代码中使用任意字符串和引号
    - 降低AI犯错概率，提升成功率
- ✅ **密钥堆叠系统 - 数量显示**:
  - **问题**：给了5个黄色密钥，物品栏只显示1个，因为去重逻辑也应用在了密钥上
  - **需求区分**：
    - 词条(token)：需要去重，每个唯一词条只显示一次
    - 密钥(key)：可以堆叠，显示数量角标
  - **技术实现**：
    - 修改addItemToInventory()函数：
      - 词条：保持原有去重逻辑
      - 密钥：查找同名密钥，如果存在则count+1，否则添加新密钥(count=1)
    - 物品数据结构：密钥添加count字段记录数量
    - 修改updateInventoryUI()：
      - 密钥内容用span包裹
      - 如果count > 1，创建数量角标显示
      - 点击显示时附带数量信息（如"黄色密钥 x5"）
    - 修改attemptUnlockWithKey()：
      - 使用密钥时，如果count > 1则减少count
      - 如果count = 1则从物品栏删除密钥
      - 刷新UI显示最新数量
  - **UI设计**：
    - 数量角标：红色圆形，显示在物品右上角
    - 位置：absolute定位，top: -8px, right: -8px
    - 样式：白色文字，阴影效果，pointer-events: none避免干扰点击
    - 只在数量>1时显示，数量为1时不显示角标
  - **效果**：
    - 密钥正确堆叠，5个黄色密钥显示为一个带"5"角标的物品
    - 使用一个后变成"4"，清晰直观
    - 词条保持去重，不会重复收集
    - 物品栏更整洁，不会被重复密钥占满
- ✅ **破解通知和权限更新系统**:
  - **问题**：
    - 破解函数后，Alex不知道权限已改变
    - buildSystemPrompt()从discoveredCode缓存读取，看不到最新权限
    - Alex可能会误认为函数还是加密状态
  - **需求**：
    - 破解成功后自动通知Alex
    - 确保Alex下次回复时看到的是最新权限状态
  - **技术实现**：
    - 修改buildSystemPrompt()函数：
      - 不再从discoveredCode缓存读取
      - 遍历discoveredObjects，找到对应的obj
      - 调用obj.getFunctionInfo()实时获取最新权限
      - 添加自然语言描述到系统提示词
    - 修改attemptUnlockWithKey()函数：
      - 破解成功后调用sendMessage()
      - 发送消息：`我用黄色密钥破解了 ${objectName} 的 ${functionName} 函数，现在权限是4了，可以编辑了。`
      - showInUI参数为false，不在聊天框重复显示玩家消息
      - Alex会自动回复确认
  - **消息格式**：
    - 明确告知：物体名称、函数名称、权限等级
    - 简洁直接，Alex可以理解并回应
  - **效果**：
    - 破解后Alex立即知道权限变化
    - Alex的回复基于最新权限状态
    - 可以直接建议玩家"现在可以让我帮你改这个函数了"
    - 形成更自然的对话流程
- ✅ **拖拽系统重构 - 简化玩家可见代码**:
  - **问题**：
    - 火柴的拖拽逻辑分散在3个函数中（startDrag、onDrag、stopDrag）
    - 代码复杂冗长，玩家看到会困惑
    - 拖拽逻辑暴露给玩家，难以修改和理解
  - **目标**：
    - 玩家只需看到一行简单代码：`this.draggable = true`
    - 把复杂的拖拽逻辑移到系统内部
    - 降低游戏难度，更易上手
  - **技术实现**：
    - **GameObject基类增强**：
      - 添加draggable属性（是否可拖拽）
      - 添加内部拖拽方法：startDragging()、updateDragging()、stopDragging()
      - 内部管理拖拽状态和偏移量（dragOffsetX/Y）
    - **火柴类简化**：
      - 删除startDrag、onDrag、stopDrag三个函数
      - onClick函数只需一行：`this.draggable = true`
      - 自然语言描述：`<func>点击时</func>：<func>开启</func><func>拖拽</func>`
    - **鼠标事件处理**：
      - mousePressed：点击后调用obj.startDragging()
      - mouseDragged：每帧调用obj.updateDragging()
      - mouseReleased：释放时调用obj.stopDragging()
      - 移除对旧函数的检查（startDrag/onDrag/stopDrag）
  - **玩家体验**：
    - 简化前：3个函数，共10多行代码
    - 简化后：1个函数，1行代码
    - 玩家可以轻松修改：
      - `this.draggable = false` - 禁用拖拽
      - 在onClick中添加其他逻辑
      - 不需要理解拖拽的实现细节
  - **向后兼容**：
    - 拖拽逻辑完全重写，不依赖旧系统
    - draggable属性默认为false，需要主动开启
    - 其他物体不受影响
  - **效果**：
    - 代码更简洁，玩家更容易理解
    - 降低解谜难度，专注于逻辑而非实现
    - 系统更健壮，拖拽逻辑统一管理
    - Alex修改代码时更简单，出错率更低
- ✅ **自然语言描述系统增强 - <attr>属性标签**:
  - **问题**：自然语言描述中属性和函数混淆，如"开启拖拽"实际是设置属性
  - **解决方案**：引入`<attr>`标签用于标记对象属性
  - **技术实现**：
    - 修改所有registerFunction调用，准确区分属性、函数、类：
      - PasswordDoor.onClick: `<func>检查</func><attr>密码</attr>`
      - PasswordDoor.onCollide: `<attr>HP</attr><func>减少</func>1`
      - Letter.onCollide: `<func>显示</func><attr>隐藏文字</attr>`
      - Match.onClick: `设置<attr>可拖拽</attr>`
      - Gyro.onClick: `<attr>旋转</attr><func>增加</func>90度`
    - 更新extractTokens()函数添加attr标签提取
    - 更新parseNaturalDescription()正则表达式支持attr标签
    - 添加CSS样式：attr词条显示为淡蓝色（#8ab4f8）
    - 更新Alex系统提示词，添加attr标签文档和示例
    - 代码卡片顶部添加类名标题，提升物体识别度
  - **词条分类**：
    - 函数/动作用`<func>`：生成、显示、检查、增加、减少等（绿色 #00ff00）
    - 类名用`<class>`：金币、火柴、存钱罐等（青色 #4ecca3）
    - 属性用`<attr>`：HP、密码、可拖拽、旋转、隐藏文字等（淡蓝色 #8ab4f8）
  - **视觉优化**：
    - 属性词条使用淡蓝色，与绿色和青色形成和谐的色彩体系
    - 代码卡片顶部添加类名标题，方便玩家识别物体类型
    - 类名使用中文，采用类名词条样式（青色包围盒），可点击收集
    - 类名标题有分隔线和发光效果，提升可读性
  - **类名系统**：
    - GameObject添加classNameCN属性存储中文类名
    - 每个物体在constructor中设置中文类名：
      - PasswordDoor: '密码门'
      - PiggyBank: '存钱罐'
      - Coin: '金币'
      - Letter: '信纸'
      - Match: '火柴'
      - Gyro: '陀螺'
    - getFunctionInfo()返回中文类名用于显示
    - 代码卡片顶部的类名词条可点击收集到物品栏
  - **效果**：
    - 自然语言描述更准确反映代码实际操作
    - 玩家能清楚区分函数调用和属性访问
    - 提升代码可读性和学习价值
    - Alex生成代码时更准确理解意图

## Git仓库
- GitHub: https://github.com/fangkejustcan/console-robot-puzzle-v1
- 分支: main

## 待测试项目
- [ ] 游戏完整流程测试
- [ ] DeepSeek API连接测试
- [ ] AlexEdit代码修改功能测试（已基本验证，需要AI交互测试）
- [ ] 胜利条件触发测试
- [ ] 物体碰撞检测测试
- [ ] 拖拽功能测试
- [ ] 动态代码执行测试

## 调试说明

### 查看调试日志
1. 按F12打开浏览器开发者工具
2. 切换到Console标签
3. 所有AlexEdit的执行过程都会打印详细日志
4. 可以看到代码匹配、执行、错误等信息

## 已知问题
- CORS代理服务可能偶尔不稳定（如果不可用，可尝试更换其他代理服务）

## 未来优化方向
- 添加更多关卡
- 增加音效和背景音乐
- 优化AI对话体验
- 添加代码高亮显示
- 增加游戏教程
